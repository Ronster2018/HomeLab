# =========================================================
# Traefik Dashboard — Production Ingress + Middlewares
# ---------------------------------------------------------
# This manifest accomplishes:
#   • HTTP → HTTPS redirect
#   • Root "/" → "/dashboard/" redirect
#   • Secure dashboard exposure via Traefik CRDs
#
# Apply with:
#   kubectl apply -f traefik-dashboard.yaml
# =========================================================

# =========================================================
# Middleware: Redirect HTTP → HTTPS
# ---------------------------------------------------------
# Forces all HTTP requests onto HTTPS
# Attached to the web (port 80) entrypoint
# =========================================================
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: traefik-redirect-to-https
  namespace: traefik
spec:
  redirectScheme:
    scheme: https
    permanent: true
---
# =========================================================
# Middleware: Redirect root → /dashboard/
# ---------------------------------------------------------
# Traefik dashboard is not served at "/"
# This ensures users landing on the root are forwarded
# =========================================================
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: traefik-dashboard-redirect
  namespace: traefik
spec:
  redirectRegex:
    regex: ^https?://traefik\.home\.sparhomelab\.dev/?$
    replacement: https://traefik.home.sparhomelab.dev/dashboard/
    permanent: true
---
# =========================================================
# IngressRoute: HTTP entrypoint (web)
# ---------------------------------------------------------
# Purpose:
#   Catch HTTP traffic and force HTTPS
# =========================================================
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: traefik-dashboard-web
  namespace: traefik
spec:
  entryPoints:
  - web

  routes:
  - match: Host(`traefik.home.sparhomelab.dev`)
    kind: Rule
    middlewares:
    - name: traefik-redirect-to-https
    services:
    # Dummy service required by Traefik
    # Traffic never actually reaches backend
    - name: api@internal
      kind: TraefikService
---
# =========================================================
# IngressRoute: HTTPS entrypoint (websecure)
# ---------------------------------------------------------
# Purpose:
#   • Serve Traefik dashboard securely
#   • Redirect root → /dashboard/
# =========================================================
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: traefik-dashboard-websecure
  namespace: traefik
spec:
  entryPoints:
  - websecure

  routes:
  - match: Host(`traefik.home.sparhomelab.dev`) && (PathPrefix(`/dashboard`) || PathPrefix(`/api`) || PathPrefix(`/`))
    kind: Rule
    middlewares:
    - name: traefik-dashboard-redirect
    services:
    - name: api@internal
      kind: TraefikService
  # -------------------------------------------------------
  # TLS certificate (must exist via cert-manager)
  # -------------------------------------------------------
  tls:
    secretName: traefik-tls
